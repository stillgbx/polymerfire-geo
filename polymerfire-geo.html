<!--
@license
ToDo license
-->

<!-- Polymer elements -->
<link rel="import" href="../polymer/polymer.html">
<!-- Firebase elements -->
<link rel="import" href="../polymerfire/firebase-database-behavior.html">
<!-- Polymerfire-Geo elements -->
<link rel="import" href="bulk-changes-behavior.html">
<!-- Geofire -->
<link rel="import" href="geofire.html">

<!--
`polymerfire-geo`
Polymer Web Component for Firebase GeoFire

@demo demo/index.html
-->

<dom-module id="polymerfire-geo">

  <script>
    "use strict";

    Polymer({
      is: "polymerfire-geo",

      properties: {
        /**
         *
         */
        geo: {
          type: Object,
          notify: true,
          computed: "_computeGeo(ref)"
        },

        /**
         *
         */
        bounds: {
          type: Object
        },

        _query: Object,

        _center: {
          type: Object,
          computed: "_computeCenter(bounds)"
        },

        _radius: {
          type: Number,
          computed: "_computeRadius(bounds)"
        },

        /**
         *
         */
        bulkChanges: {
          type: Boolean,
          value: false,
          observer: "_bulkChangesChanged"
        },

        /**
         *
         */
        processing: {
          type: Boolean,
          value: false,
          readOnly: true,
          notify: true
        }
      },

      behaviors: [
        Polymer.FirebaseDatabaseBehavior,
        BulkChangesBehavior
      ],

      observers: [
        "_queryParamChanged(geo, _center, _radius)"
      ],

      /**
       * @override
       */
      get isNew() {
        return this.disabled || !this.__pathReady(this.path);
      },

      /**
       * @override
       */
      get zeroValue() {
        return {};
      },

      /**
       * @override
       */
      reset: function() {
        this.path = null;
        return Promise.resolve();
      },

      /**
       * @override
       */
      memoryPathToStoragePath: function(path) {
        var storagePath = this.path;

        if(path !== "data"){
          storagePath += path.replace(/^data\.?/, "/").split(".").join("/");
        }

        return storagePath;
      },

      /**
       * @override
       */
      storagePathToMemoryPath: function(storagePath) {
        var path = "data";

        storagePath =
            storagePath.replace(this.path, "").split("/").join(".");

        if(storagePath){
          path += "." + storagePath;
        }

        return path;
      },

      ready: function(){
        this._init();
      },

      detached: function(){
        this._resetQuery();
      },

      _init: function(){
        this.data = this.zeroValue;
      },

      _computeGeo: function(ref){
        if(!ref){
          return null;
        }

        this._resetQuery();

        return new GeoFire(ref);
      },

      _computeCenter: function(bounds){
        if(!bounds){
          return null;
        }

        return this._getBoundsCenter(bounds);
      },

      _computeRadius: function(bounds){
        if(!bounds){
          return 0;
        }

        return this._getRadiusFromBounds(bounds);
      },

      _bulkChangesChanged: function(newValue, oldValue){
        if(newValue){
          this._initChanges("geoData");
        }
        else{
          this._deleteChanges("geoData");
        }
      },

      _queryParamChanged: function(geo, center, radius){
        if(this.disabled || !geo){
          return;
        }

        this.debounce("build-query", this._buildQuery.bind(this, geo, center, radius));
      },

      _getBoundsCenter: function(bounds){
        var center = {
            lat: null,
            lng: null
        };

        if(!bounds){
          return center;
        }

        center.lat = bounds.southWest.lat + ( (bounds.northEast.lat - bounds.southWest.lat) / 2 );
        center.lng = bounds.southWest.lng + ( (bounds.northEast.lng - bounds.southWest.lng) / 2 );

        return center;
      },

      _getRadiusFromBounds: function(bounds){
        if(!bounds){
          return 0;
        }

        return GeoFire.distance([bounds.northEast.lat, bounds.northEast.lng], [bounds.southWest.lat, bounds.southWest.lng]) / 2;
      },

      _buildQuery: function(geo, center, radius){
        if(this.disabled || !geo){
          return;
        }

        this._setProcessing(true);

        var query = this._query;
        if(!query){
          this._query = geo.query({center: [center.lat, center.lng], radius: radius});
          query = this._query;

          // ready
          query.on("ready", function(){
            if(this._changesHappened("geoData")){
              this._resetChangesHappened("geoData");
            }
            else{
              this._bulkNoChange("geoData");
            }
            this._setProcessing(false);
          }.bind(this));

          // key_entered
          query.on("key_entered", function(key, location, distance, customData){
            var data = {"$key": key, "lat": location[0], "lng": location[1]};
            for(var cdKey in customData){
              data[cdKey] = customData[cdKey];
            }
            this._add(key, data);
          }.bind(this));

          // key_exited
          query.on("key_exited", function(key, location, distance){
            if(this.data.hasOwnProperty(key)){
              this._remove(key);
            }
          }.bind(this));

          // key_moved
          query.on("key_moved", function(key, location, distance){
            if(this._keep(location)){
              this._update(key, {"$key": key, "lat": location[0], "lng": location[1]}, false);
            }
            else{
              this._remove(key, false);
            }

            if(this.bulkChanges){
              this._debounceComplete("geoData");
            }

          }.bind(this));
        }
        else{
          query.updateCriteria({center: [center.lat, center.lng], radius: radius});
        }
      },

      _add: function(key, data, noDebounceComplete){
        if(this.bulkChanges){
          this.data[key] = data;
          this._changesAdd("geoData", key, noDebounceComplete);
        }
        else{
          this.set("data." + key, data);
        }
      },

      _update: function(key, data, noDebounceComplete){
        if(this.bulkChanges){
          this.data[key] = {"lat": location[0], "lng": location[1]};
          this._changesUpdate("geoData", key, noDebounceComplete);
        }
        else{
          this.set("data." + key, {"lat": location[0], "lng": location[1]});
        }
      },

      _remove: function(key, noDebounceComplete){
        if(this.bulkChanges){
          var data = this.data[key];
          delete this.data[key];
          this._changesRemove("geoData", key, data, noDebounceComplete);
        }
        else{
          this.set("data." + key, null);
          delete this.data[key];
        }
      },

      _resetQuery: function(){
        if(this._query){
          this._query.cancel();
          this._query = null;
        }
      },

      _keep: function(location){
        return this._isLocationBounds(location);
      },

      _isLocationBounds: function(location){
        if(location[0] <= this.bounds.northEast.lat && location[0] >= this.bounds.southWest.lat &&
           location[1] <= this.bounds.northEast.lng && location[1] >= this.bounds.southWest.lng){
             return true;
        }
        return false;
      }
    });

  </script>

</dom-module>
